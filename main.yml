---

# Copyright 2022 Cloudera, Inc. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Primary entrypoint for all CDP installations (Public Cloud, Private Cloud)
#
# There are five "core" runlevels:
# - validate
# - initialize
# - infra
# - plat
# - run
# - teardown
#
# In this context, 'run' means 'runtime' or 'application'. The platform level
# is now both CDP Public Cloud SDX and Data Services, which is a change
# from before where 'plat' referred to the DL and SDX and 'run' referred to the
# Data Services.
# 
# Individual Data Services (and Datahubs) should be tagged _within_ the 
# 'cloudera.exe.*' roles themselves:
# - de
# - df
# - dh
# - dw
# - ml
# - opdb

- name: Initialize Cloudera Deploy Run
  hosts: localhost
  connection: local
  gather_facts: yes
  tags: always
  tasks:
    - ansible.builtin.include_role:
        name: cloudera.exe.init_deployment
        public: yes
      when: init__completed is undefined

- ansible.builtin.import_playbook: "{{ [definition_path, 'pre_teardown.yml'] | path_join }}"
  when:
    - hostvars.localhost.run_infrastructure or hostvars.localhost.run_platform or hostvars.localhost.run_teardown

- ansible.builtin.import_playbook: pbc_teardown.yml
  when:
    - hostvars.localhost.run_infrastructure or hostvars.localhost.run_teardown
    - hostvars.localhost.init__call_cdp_pbc == True

- ansible.builtin.import_playbook: pvc_base_teardown.yml
  when:
    - hostvars.localhost.run_infrastructure or hostvars.localhost.run_teardown
    - hostvars.localhost.init__call_cdp_pvc == True

- ansible.builtin.import_playbook: "{{ [definition_path, 'pre_setup.yml'] | path_join }}"
  when:
    - hostvars.localhost.run_infrastructure or hostvars.localhost.run_platform or hostvars.localhost.run_runtime

- ansible.builtin.import_playbook: pbc_setup.yml
  when:
    - hostvars.localhost.run_platform or hostvars.localhost.run_runtime
    - hostvars.localhost.init__call_cdp_pbc == True

- ansible.builtin.import_playbook: pvc_base_prereqs_ext.yml
  when:
    - hostvars.localhost.run_platform or hostvars.localhost.run_runtime
    - hostvars.localhost.init__call_cdp_pvc == True

- ansible.builtin.import_playbook: pvc_base_prereqs_int.yml
  when:
    - hostvars.localhost.run_platform or hostvars.localhost.run_runtime
    - hostvars.localhost.init__call_cdp_pvc == True

- ansible.builtin.import_playbook: pvc_base_setup.yml
  when:
    - hostvars.localhost.run_platform or hostvars.localhost.run_runtime
    - hostvars.localhost.init__call_cdp_pvc == True

- ansible.builtin.import_playbook: pvc_base_postfix.yml
  when:
    - hostvars.localhost.run_platform or hostvars.localhost.run_runtime
    - hostvars.localhost.init__call_cdp_pvc == True

- ansible.builtin.import_playbook: "{{ [definition_path, 'post_setup.yml'] | path_join }}"
  when:
    - hostvars.localhost.run_runtime

- ansible.builtin.import_playbook: "{{ [definition_path, 'post_teardown.yml'] | path_join }}"
  when:
    - hostvars.localhost.run_teardown
